<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Project Proposal</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
	<style>
	body {
		margin: 50px;
	}

	#sampleImages {
		display: grid;
		grid-template-columns: repeat(4, 20%);
		gap: 16px;
	}

	#sampleImages img {
		max-width: 200px;
		max-height: 200px;
		cursor: pointer;
	}

	#sampleImages img.selected {
     border-style:solid;
     border-width:thick;
	 border-color:blue;
	}

	</style>
</head>
<body>

<h2>Generate Project Proposal Demo</h2>

<p>
<label for="author">Prepared by:</label>
<input type="text" id="author" value="Chad Smith">
</p>

<p>
<label for="date">Date:</label>
<input type="date" id="date">
</p>

<p>
<label for="projectName">Project Name</label>
<input type="text" id="projectName" value="Project X">
</p>

<p>
<label for="clientName">Client Name</label>
<input type="text" id="clientName" value="Client Zeta">
</p>

<p>
<label for="clientCompany">Client Company</label>
<input type="text" id="clientCompany" value="Company Gamma">
</p>

<p>
<label for="contractorName">Contractor Name</label>
<input type="text" id="contractorName" value="Jacob Camden">
</p>

<p>
<label for="contractorCompany">Contractor Company</label>
<input type="text" id="contractorCompany" value="Camden Tech, Inc.">
</p>

<p>
<label for="contractorCompanyProfile">Contractor Company Profile</label>
<textarea id="contractorCompanyProfile">
Medical Insurance Provider
</textarea>
</p>

<p>
<label for="contractorCompanySkills">Contractor Company Skills</label>
<textarea id="contractorCompanySkills">
Deals in providing wide range of Healthcare Policies for all age segments
</textarea>
</p>


<!--
<p>
<label for="amount">Total Dollar Amount</label>
<input type="number" id="number" value="500000">
</p>
-->

<p>
<label for="prompt">Contract Logo (AI Driven)</label>
<input type="text" id="prompt" placeholder="Type in a prompt here to generate images." value="stack of papers on a desk">
<button id="generateImages">Generate Images</button>
</p>
<div id="sampleImages"></div>

<p>
<button id="submitBtn">Generate PDF</button>
</p>

<script src="https://documentservices.adobe.com/view-sdk/viewer.js"></script>
<script>
const ADOBE_KEY = '9861538238544ff39d37c6841344b78d';

let $prompt, $generateImages, $sampleImages, $submitBtn;
let $name, $address, $number;

document.addEventListener('DOMContentLoaded', init, false);
async function init() {

	$prompt = document.querySelector('#prompt');
	$generateImages = document.querySelector('#generateImages');
	$generateImages.addEventListener('click', generateImages, false);
	$sampleImages = document.querySelector('#sampleImages');
	$submitBtn = document.querySelector('#submitBtn');
	$submitBtn.addEventListener('click', submitForm, false);

	$author = document.querySelector('#author');
	$date = document.querySelector('#date');
	$projectName = document.querySelector('#projectName');
	$clientName = document.querySelector('#clientName');
	$clientCompany = document.querySelector('#clientCompany');
	$contractorName = document.querySelector('#contractorName');
	$contractorCompany = document.querySelector('#contractorCompany');
	$contractorCompanyProfile = document.querySelector('#contractorCompanyProfile');
	$contractorCompanySkills = document.querySelector('#contractorCompanySkills');
	
	//$number = document.querySelector('#number');
}

async function generateImages() {
	let prompt = $prompt.value.trim();
	let origText = $generateImages.innerText;
	if(!prompt) return;
	console.log(`Create images for: ${prompt}`);

	let imgs = document.querySelectorAll('#sampleImages img');
	// clean up old handlers
	imgs.forEach(i => {
		i.removeEventListener(selectImage);
	});

	$sampleImages.innerHTML = '';

	$generateImages.setAttribute('disabled', 'disabled');
	$generateImages.innerText = 'Generating...';
	let req = await fetch('/genImage', { method:'POST', body: JSON.stringify({prompt})});
	let results = await req.json();
	console.log(results);

	let htmlResult = '';
	results.forEach(p => {
		htmlResult += `<div><img src="${p.image.presignedUrl}"></div>`;
	});
	$sampleImages.innerHTML = htmlResult;

	$generateImages.removeAttribute('disabled');
	$generateImages.innerText = origText;
	
	//set up click handler so we can note the user's choice
	imgs = document.querySelectorAll('#sampleImages img');

	imgs.forEach(i => {
		i.addEventListener('click', selectImage);
	});

}

function selectImage(e) {
	let imgs = document.querySelectorAll('#sampleImages img');
	imgs.forEach(i => {
		if(i == e.target) {
			if(i.classList.contains('selected')) i.classList.remove('selected');
			else i.classList.add('selected');
		} else i.classList.remove('selected');
	});
}

async function submitForm(e) {
	e.preventDefault();
	console.log('Attempting to generate the PDF, here goes nothing');
	
	//rewrite the date a bit
	let [year, month, day] = $date.value.split('-');
	let dateStr = `${month}/${day}/${year}`;
	let body = {
		author: $author.value, 
		date: dateStr,
		projectName: $projectName.value, 
		clientName: $clientName.value, 
		clientCompany: $clientCompany.value,
		contractorName: $contractorName.value,
		contractorCompany: $contractorCompany.value,
		contractorCompanyProfile: $contractorCompanyProfile.value,
		contractorCompanySkills: $contractorCompanySkills.value,
//		number: parseInt($number.value,10)
	}
	console.log('body before ff', body);
	let imgs = document.querySelectorAll('#sampleImages img');
	imgs.forEach(i => {
		if(i.classList.contains('selected')) {
			body.image = i.src;
		}
	});
	console.log('body after ff', body);

	let req = await fetch('/genPDF', { method:'POST', body: JSON.stringify(body)});
	let res = await req.text();

	let adobeDCView = new AdobeDC.View({clientId: ADOBE_KEY});
	adobeDCView.previewFile({
		content:{ promise: base64ToArrayBuffer(res)},
		metaData:{fileName: "contract.pdf"}
	}, 
	{
		embedMode: "LIGHT_BOX"
	});	
}

async function base64ToArrayBuffer(base64) {
    var binary_string = window.atob(base64);
    var len = binary_string.length;
    var bytes = new Uint8Array(len);
    for (var i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes.buffer;
}

</script>
</body>
</html>